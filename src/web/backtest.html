<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Six Trading - Backtesting</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <style>
        :root {
            --bg-dark: #121212;
            --card-bg: #1e1e1e;
            --accent-blue: #2196F3;
            --accent-green: #4CAF50;
            --accent-red: #F44336;
            --text-main: #e0e0e0;
            --text-muted: #9e9e9e;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 15px;
        }

        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .nav-link {
            color: var(--accent-blue);
            text-decoration: none;
            font-size: 0.9rem;
        }

        .btn {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn:disabled {
            background: #444;
            cursor: not-allowed;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .status-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 5px;
            display: block;
        }

        .value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .chart-container {
            height: 400px;
            margin-top: 20px;
        }

        select {
            background: #2a2a2a;
            color: white;
            border: 1px solid #444;
            padding: 8px;
            border-radius: 4px;
        }

        .strategy-list {
            display: flex;
            gap: 10px;
            background: #2a2a2a;
            padding: 8px 15px;
            border-radius: 6px;
            border: 1px solid #444;
            flex-wrap: wrap;
        }

        .strategy-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .strategy-item input {
            cursor: pointer;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .strategy-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--accent-blue);
        }

        /* Range Slider Styles */
        .range-container {
            margin: 20px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .slider-track {
            position: relative;
            width: 100%;
            height: 8px;
            background: #333;
            border-radius: 4px;
            margin: 20px 0;
        }

        .slider-handle {
            position: absolute;
            top: 50%;
            width: 20px;
            height: 20px;
            background: var(--accent-blue);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 2;
        }

        .slider-range {
            position: absolute;
            top: 0;
            height: 100%;
            background: rgba(33, 150, 243, 0.3);
            border-radius: 4px;
            z-index: 1;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div>
                <h1 style="margin:0; color: var(--accent-blue);">Backtest Engine</h1>
                <a href="/" class="nav-link">‚Üê Back to Dashboard</a>
            </div>
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <div id="strategy-container" class="strategy-list" style="max-height: 150px; overflow-y: auto;">
                    <!-- Strategies with checkboxes will be loaded here -->
                </div>
                <div id="symbol-container" class="strategy-list" style="max-height: 150px; overflow-y: auto;">
                    <!-- Symbols with checkboxes will be loaded here -->
                </div>
                <button id="download-btn" class="btn" style="background: #FF9800;" onclick="downloadData()">üì• Download
                    Data</button>
                <button id="run-btn" class="btn" onclick="runBacktest()">Run Backtest</button>
            </div>
        </div>

        <div class="card range-container">
            <span class="label">Backtest Date Range (will auto-download missing data)</span>
            <div style="display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 200px;">
                    <label style="color: var(--text-muted); font-size: 0.8rem;">Start Date</label>
                    <input type="datetime-local" id="date-start"
                        style="width: 100%; padding: 8px; background: #222; border: 1px solid #444; border-radius: 6px; color: white; font-size: 0.9rem;">
                </div>
                <div style="flex: 1; min-width: 200px;">
                    <label style="color: var(--text-muted); font-size: 0.8rem;">End Date</label>
                    <input type="datetime-local" id="date-end"
                        style="width: 100%; padding: 8px; background: #222; border: 1px solid #444; border-radius: 6px; color: white; font-size: 0.9rem;">
                </div>
            </div>
            <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap; margin-bottom: 10px;">
                <div style="color: var(--accent-blue); font-size: 0.8rem;">
                    üì• Data will be automatically downloaded from Binance if not available in database
                </div>
                <label
                    style="display: flex; align-items: center; gap: 8px; cursor: pointer; background: rgba(255,152,0,0.1); padding: 6px 12px; border-radius: 6px; border: 1px solid #FF9800;">
                    <input type="checkbox" id="fast-mode" style="width: 16px; height: 16px; cursor: pointer;">
                    <span style="color: #FF9800; font-size: 0.85rem; font-weight: 500;">‚ö° Fast Mode</span>
                    <span style="color: #888; font-size: 0.7rem;">(10x faster, samples every 10th trade)</span>
                </label>
            </div>
            <span class="label" style="margin-top: 10px;">Existing Data Range (Current Selection)</span>
            <div id="timeline-slider" class="slider-track" style="display:none;">
                <div id="slider-range" class="slider-range"></div>
                <div id="handle-start" class="slider-handle"></div>
                <div id="handle-end" class="slider-handle"></div>
            </div>
            <div class="slider-labels">
                <span id="range-min-label">-</span>
                <span id="range-current-label">Set dates above</span>
                <span id="range-max-label">-</span>
            </div>
        </div>

        <div id="results-summary" style="display: none; margin-bottom: 20px;">
            <div class="status-grid">
                <div class="status-item">
                    <span class="label">Initial Capital</span>
                    <div class="value" id="res-initial">10,000 USDT</div>
                </div>
                <div class="status-item">
                    <span class="label">Time Range</span>
                    <div class="value" id="res-range" style="font-size: 1rem; color: var(--text-muted);">Calculating...
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h2 style="margin:0">Equity Curve Comparison (Sampling Applied)</h2>
                <button class="btn" style="padding: 5px 10px; font-size: 0.8rem;" onclick="resetChartZoom()">Reset
                    Zoom</button>
            </div>
            <div class="chart-container">
                <canvas id="backtestChart"></canvas>
            </div>
        </div>

        <div id="results-grid" class="results-grid">
            <!-- Strategy result cards will be injected here -->
        </div>

        <div id="loading" style="display: none; text-align: center; padding: 50px;">
            <style>
                @keyframes shimmer {
                    0% {
                        background-position: -200% 0;
                    }

                    100% {
                        background-position: 200% 0;
                    }
                }

                @keyframes pulse {

                    0%,
                    100% {
                        opacity: 1;
                    }

                    50% {
                        opacity: 0.7;
                    }
                }

                .progress-shimmer {
                    background: linear-gradient(90deg, var(--accent-blue), var(--accent-green), var(--accent-blue));
                    background-size: 200% 100%;
                    animation: shimmer 1.5s infinite linear;
                }

                .progress-pulse {
                    animation: pulse 1s infinite;
                }

                .strategy-bar {
                    background: #222;
                    border-radius: 8px;
                    padding: 8px 12px;
                    margin: 6px 0;
                    display: grid;
                    grid-template-columns: 80px 140px 1fr 140px 50px;
                    align-items: center;
                    gap: 10px;
                    text-align: left;
                }

                .strategy-bar-symbol {
                    font-weight: bold;
                    color: var(--accent-blue);
                    font-size: 0.8rem;
                }

                .strategy-bar-name {
                    font-weight: bold;
                    font-size: 0.85rem;
                }

                .strategy-bar-progress {
                    height: 12px;
                    background: #333;
                    border-radius: 6px;
                    overflow: hidden;
                }

                .strategy-bar-fill {
                    height: 100%;
                    background: linear-gradient(90deg, var(--accent-blue), var(--accent-green));
                    transition: width 0.3s ease;
                }

                .strategy-bar-status {
                    text-align: right;
                    font-size: 0.85rem;
                }

                .strategy-bar-features {
                    font-size: 0.7rem;
                    color: var(--text-muted);
                    font-style: italic;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                }
            </style>
            <div style="font-size: 1.5rem; color: var(--text-muted); margin-bottom: 20px;" class="progress-pulse">
                Running Combinatorial Backtest...</div>
            <div id="strategy-progress" style="width: 100%; max-width: 1000px; margin: 0 auto;">
                <!-- Per-combination progress bars -->
            </div>
        </div>
    </div>

    <script>
        let backtestChart = null;
        let dataMin = 0;
        let dataMax = 0;

        async function init() {
            const res = await fetch('/api/status');
            const status = await res.json();

            // Populate Strategy Checkboxes
            const strategyContainer = document.getElementById('strategy-container');
            if (strategyContainer && status.available_strategies) {
                strategyContainer.innerHTML = '<span class="label" style="width:100%">Strategies</span>' +
                    status.available_strategies.map(s => `
                    <div class="strategy-item">
                        <input type="checkbox" id="strat-${s}" value="${s}" ${s === 'MeanReversion' ? 'checked' : ''}> 
                        <label for="strat-${s}">${s}</label>
                    </div>
                `).join('');
            }

            // Populate Symbol Checkboxes with Market Grouping
            const symbolContainer = document.getElementById('symbol-container');
            if (symbolContainer) {
                symbolContainer.innerHTML = '<span class="label" style="width:100%">Markets</span>';

                // Spot
                symbolContainer.innerHTML += '<div style="width:100%; font-size:0.7rem; color:var(--accent-green); margin-top:5px;">SPOT</div>';
                status.available_markets.forEach(s => {
                    symbolContainer.innerHTML += `
                        <div class="strategy-item">
                            <input type="checkbox" id="sym-spot-${s}" value="SPOT:${s}" ${s === 'BTCUSDT' ? 'checked' : ''}> 
                            <label for="sym-spot-${s}">${s}</label>
                        </div>
                    `;
                });

                // Futures (Hardcoded for now as example if not in available_markets)
                const futures = ["BTCUSDT", "ETHUSDT", "SOLUSDT"];
                symbolContainer.innerHTML += '<div style="width:100%; font-size:0.7rem; color:var(--accent-red); margin-top:5px;">FUTURES</div>';
                futures.forEach(s => {
                    symbolContainer.innerHTML += `
                        <div class="strategy-item">
                            <input type="checkbox" id="sym-fut-${s}" value="FUTURES:${s}"> 
                            <label for="sym-fut-${s}">${s}</label>
                        </div>
                    `;
                });
            }

            // Set default dates
            const now = Date.now();
            document.getElementById('date-start').value = toLocalISOString(now - (24 * 60 * 60 * 1000));
            document.getElementById('date-end').value = toLocalISOString(now);
        }

        function toLocalISOString(ts) {
            const d = new Date(ts);
            return new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
        }

        async function runBacktest() {
            const stratChecked = document.querySelectorAll('#strategy-container input:checked');
            const symChecked = document.querySelectorAll('#symbol-container input:checked');

            const strategies = Array.from(stratChecked).map(c => c.value);
            const symbols = Array.from(symChecked).map(c => c.value);

            if (strategies.length === 0 || symbols.length === 0) {
                alert("Please select at least one strategy and one market.");
                return;
            }

            const startTs = new Date(document.getElementById('date-start').value).getTime();
            const endTs = new Date(document.getElementById('date-end').value).getTime();

            if (!startTs || !endTs || isNaN(startTs) || isNaN(endTs) || startTs >= endTs) {
                alert("Please select a valid date range.");
                return;
            }

            // Debug logging
            const diffHours = (endTs - startTs) / (1000 * 60 * 60);
            console.log(`Backtest range: ${new Date(startTs)} to ${new Date(endTs)} | Diff: ${diffHours} hours`);
            console.log(`Sending: strategies=${JSON.stringify(strategies)}, symbols=${JSON.stringify(symbols)}, start_ts=${startTs}, end_ts=${endTs}`);

            document.getElementById('loading').style.display = 'block';
            document.getElementById('results-summary').style.display = 'none';
            document.getElementById('results-grid').innerHTML = '';

            const strategyProgress = document.getElementById('strategy-progress');
            strategyProgress.innerHTML = '';

            const combinations = [];
            symbols.forEach(sym => {
                strategies.forEach(strat => {
                    const id = `${sym}-${strat}`.replace(/[:\s]/g, '-');
                    combinations.push(id);
                    strategyProgress.innerHTML += `
                        <div class="strategy-bar" id="bar-${id}">
                            <div class="strategy-bar-symbol">${sym.split(':')[1]} <small style="display:block; font-size:0.6rem; color:#888">${sym.split(':')[0]}</small></div>
                            <div class="strategy-bar-name">${strat}</div>
                            <div class="strategy-bar-progress">
                                <div class="strategy-bar-fill" id="fill-${id}" style="width: 0%;"></div>
                            </div>
                            <div class="strategy-bar-features" id="features-${id}"></div>
                            <div class="strategy-bar-status" id="status-${id}">0%</div>
                        </div>
                    `;
                });
            });

            const eventSource = new EventSource('/api/backtest/progress');
            eventSource.onmessage = function (event) {
                try {
                    const data = JSON.parse(event.data);
                    const symSpec = data.symbol.includes(':') ? data.symbol : `SPOT:${data.symbol}`; // fallback
                    // Wait, the backend symbol format might be just symbol name, need to match correctly.
                    // Actually I changed backend to include symbols like "SPOT:BTCUSDT"
                    const id = `${data.symbol}-${data.strategy_name}`.replace(/[:\s]/g, '-');

                    const fill = document.getElementById(`fill-${id}`);
                    const status = document.getElementById(`status-${id}`);
                    const bar = document.getElementById(`bar-${id}`);

                    if (fill && status) {
                        fill.style.width = data.progress_pct + '%';
                        const featEl = document.getElementById(`features-${id}`);
                        if (featEl && data.features) {
                            featEl.innerText = Object.entries(data.features).map(([k, v]) => `${k}:${v}`).join(', ');
                        }
                        if (data.status === 'completed') {
                            status.innerText = '‚úÖ';
                            if (bar) bar.style.background = 'rgba(76, 175, 80, 0.15)';
                        } else {
                            status.innerText = data.progress_pct + '%';
                        }
                    }
                } catch (e) { console.error('SSE Error:', e); }
            };

            const backtestStartTime = Date.now();
            const fastMode = document.getElementById('fast-mode').checked;

            try {
                const response = await fetch('/api/backtest/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ strategies, symbols, start_ts: startTs, end_ts: endTs, fast_mode: fastMode })
                });

                eventSource.close();
                if (!response.ok) throw new Error("Execution failed");

                const report = await response.json();
                const elapsedMs = Date.now() - backtestStartTime;
                const elapsedSec = (elapsedMs / 1000).toFixed(1);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('results-summary').style.display = 'block';
                document.getElementById('res-range').innerText = `${new Date(startTs).toLocaleString()} - ${new Date(endTs).toLocaleString()} (${elapsedSec}s)`;

                renderReports(report.reports);
            } catch (err) {
                eventSource.close();
                document.getElementById('loading').style.display = 'none';
                alert("Error: " + err.message);
            }
        }

        async function downloadData() {
            const startTs = new Date(document.getElementById('date-start').value).getTime();
            const endTs = new Date(document.getElementById('date-end').value).getTime();
            const symChecked = document.querySelectorAll('#symbol-container input:checked');
            const symbols = Array.from(symChecked).map(c => c.value);

            if (symbols.length === 0) { alert("Select at least one market."); return; }
            if (!startTs || !endTs || startTs >= endTs) { alert("Invalid date range."); return; }

            const btn = document.getElementById('download-btn');
            const originalText = btn.innerText;
            btn.disabled = true;

            let successCount = 0;
            let failCount = 0;

            for (let i = 0; i < symbols.length; i++) {
                const symSpec = symbols[i];
                const [mType, symbol] = symSpec.split(':');
                btn.innerText = `‚è≥ ${i + 1}/${symbols.length}: ${symbol}`;

                try {
                    const response = await fetch('/api/download_data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ symbol, market_type: mType, start_ts: startTs, end_ts: endTs })
                    });

                    if (response.ok) {
                        successCount++;
                    } else {
                        failCount++;
                        console.error(`Download failed for ${symSpec}: `, await response.text());
                    }
                } catch (e) {
                    failCount++;
                    console.error(`Network error for ${symSpec}`, e);
                }
            }

            btn.disabled = false;
            btn.innerText = originalText;

            if (failCount > 0) {
                alert(`Download completed: ${successCount} succeeded, ${failCount} failed.`);
            } else {
                alert(`Download completed successfully for ${successCount} symbol(s).`);
            }
        }

        function renderReports(reports) {
            const grid = document.getElementById('results-grid');
            grid.innerHTML = '';

            const sorted = [...reports].sort((a, b) => b.yield_pct - a.yield_pct);

            const table = document.createElement('table');
            table.style.cssText = 'width: 100%; border-collapse: collapse; font-size: 0.85rem;';
            table.innerHTML = `
                <thead>
                    <tr style="background: rgba(255,255,255,0.05); text-align: left;">
                        <th style="padding: 10px; border-bottom: 1px solid #333;">Market</th>
                        <th style="padding: 10px; border-bottom: 1px solid #333;">Strategy</th>
                        <th style="padding: 10px; border-bottom: 1px solid #333; text-align: right;">Trades</th>
                        <th style="padding: 10px; border-bottom: 1px solid #333; text-align: right;">Yield</th>
                        <th style="padding: 10px; border-bottom: 1px solid #333; text-align: right;">Win%</th>
                        <th style="padding: 10px; border-bottom: 1px solid #333; text-align: right;">Sharpe</th>
                        <th style="padding: 10px; border-bottom: 1px solid #333; text-align: right;">Max DD</th>
                        <th style="padding: 10px; border-bottom: 1px solid #333;">Indicators</th>
                    </tr>
                </thead>
                <tbody id="results-tbody"></tbody>
            `;

            const tbody = table.querySelector('#results-tbody');
            sorted.forEach(repo => {
                const pnlColor = repo.yield_pct >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                const row = document.createElement('tr');
                row.style.cssText = 'border-bottom: 1px solid #222;';
                row.innerHTML = `
                    <td style="padding: 8px; font-weight: bold; color: var(--accent-blue);">${repo.symbol}</td>
                    <td style="padding: 8px;">${repo.strategy_name}</td>
                    <td style="padding: 8px; text-align: right;">${repo.total_trades}</td>
                    <td style="padding: 8px; text-align: right; color: ${pnlColor}; font-weight: bold;">${repo.yield_pct.toFixed(2)}%</td>
                    <td style="padding: 8px; text-align: right;">${repo.win_rate.toFixed(1)}%</td>
                    <td style="padding: 8px; text-align: right;">${repo.sharpe_ratio.toFixed(2)}</td>
                    <td style="padding: 8px; text-align: right; color: var(--accent-red);">${repo.max_drawdown.toFixed(2)}</td>
                    <td style="padding: 8px; font-size: 0.7rem; color: var(--text-muted);">${Object.entries(repo.features).map(([k, v]) => `${k}:${v}`).join(' | ')}</td>
                `;
                tbody.appendChild(row);
            });
            grid.appendChild(table);
            renderMultiChart(reports);
        }

        function renderMultiChart(reports) {
            const ctx = document.getElementById('backtestChart').getContext('2d');
            if (backtestChart) backtestChart.destroy();

            const colors = ['#2196F3', '#4CAF50', '#FF9800', '#E91E63', '#9C27B0', '#00BCD4', '#FFEB3B'];
            const datasets = reports.map((repo, idx) => ({
                label: `${repo.symbol} | ${repo.strategy_name}`,
                data: repo.history.map(h => ({ x: h.timestamp, y: h.equity })),
                borderColor: colors[idx % colors.length],
                borderWidth: 2,
                pointRadius: 0,
                tension: 0.1
            }));

            backtestChart = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                displayFormats: {
                                    hour: 'MMM d, HH:mm',
                                    day: 'MMM d, yyyy',
                                    week: 'MMM d, yyyy'
                                },
                                tooltipFormat: 'yyyy-MM-dd HH:mm'
                            },
                            ticks: { color: '#9e9e9e', maxRotation: 45 },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        y: { ticks: { color: '#9e9e9e' }, title: { display: true, text: 'Equity (USDT)', color: '#9e9e9e' } }
                    },
                    plugins: {
                        zoom: { zoom: { wheel: { enabled: true }, mode: 'x' }, pan: { enabled: true, mode: 'x' } },
                        legend: { labels: { color: '#9e9e9e', boxWidth: 10, font: { size: 10 } } }
                    }
                }
            });
        }

        function resetChartZoom() { if (backtestChart) backtestChart.resetZoom(); }
        window.onload = init;
    </script>
</body>

</html>